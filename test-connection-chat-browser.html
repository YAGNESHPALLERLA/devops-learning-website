<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection & Chat Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #3b82f6;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section h2 {
            color: #60a5fa;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        .user-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .user-box {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
        }
        .user-box h3 {
            color: #3b82f6;
            margin-bottom: 10px;
        }
        input, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #333;
            border-radius: 4px;
            background: #0a0a0a;
            color: #fff;
            font-size: 14px;
        }
        input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        button {
            background: #3b82f6;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #333;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        .status.success {
            background: #065f46;
            color: #6ee7b7;
        }
        .status.error {
            background: #7f1d1d;
            color: #fca5a5;
        }
        .status.info {
            background: #1e3a8a;
            color: #93c5fd;
        }
        .log {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #333;
            padding-left: 10px;
        }
        .log-entry.success {
            border-left-color: #10b981;
        }
        .log-entry.error {
            border-left-color: #ef4444;
        }
        .log-entry.info {
            border-left-color: #3b82f6;
        }
        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Connection & Chat Test Suite</h1>
        
        <!-- User Setup -->
        <div class="test-section">
            <h2>Step 1: User Setup</h2>
            <div class="user-panel">
                <div class="user-box">
                    <h3>User 1</h3>
                    <input type="text" id="user1Name" placeholder="Name" value="Test User 1">
                    <input type="email" id="user1Email" placeholder="Email" value="">
                    <input type="password" id="user1Password" placeholder="Password" value="Test@123456">
                    <button onclick="registerUser1()">Register User 1</button>
                    <button onclick="loginUser1()">Login User 1</button>
                    <div id="user1Status"></div>
                </div>
                <div class="user-box">
                    <h3>User 2</h3>
                    <input type="text" id="user2Name" placeholder="Name" value="Test User 2">
                    <input type="email" id="user2Email" placeholder="Email" value="">
                    <input type="password" id="user2Password" placeholder="Password" value="Test@123456">
                    <button onclick="registerUser2()">Register User 2</button>
                    <button onclick="loginUser2()">Login User 2</button>
                    <div id="user2Status"></div>
                </div>
            </div>
        </div>

        <!-- Connection Test -->
        <div class="test-section">
            <h2>Step 2: Connection Test</h2>
            <div class="actions">
                <button onclick="sendConnectionRequest()">Send Request (User1 ‚Üí User2)</button>
                <button onclick="getReceivedRequests()">Get Received Requests (User2)</button>
                <button onclick="acceptConnectionRequest()">Accept Request (User2)</button>
                <button onclick="getConnectedUsers()">Get Connected Users</button>
            </div>
            <div id="connectionStatus"></div>
        </div>

        <!-- Chat Test -->
        <div class="test-section">
            <h2>Step 3: Chat Test</h2>
            <div class="actions">
                <button onclick="createChat()">Create/Get Chat</button>
                <button onclick="sendMessageUser1()">Send Message (User1)</button>
                <button onclick="sendMessageUser2()">Send Message (User2)</button>
                <button onclick="getMessages()">Get Messages</button>
            </div>
            <div id="chatStatus"></div>
        </div>

        <!-- Test Log -->
        <div class="test-section">
            <h2>Test Log</h2>
            <div class="log" id="testLog"></div>
            <button onclick="clearLog()" style="margin-top: 10px;">Clear Log</button>
        </div>
    </div>

    <script>
        const API_BASE = '/api/jobcy';
        let user1 = { token: null, id: null, email: null };
        let user2 = { token: null, id: null, email: null };
        let connectionRequestId = null;
        let chatId = null;

        // Generate unique emails
        document.getElementById('user1Email').value = `testuser1_${Date.now()}@test.com`;
        document.getElementById('user2Email').value = `testuser2_${Date.now()}@test.com`;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const headers = {
                'Content-Type': 'application/json',
                ...(options.token && { Authorization: `Bearer ${options.token}` }),
                ...options.headers
            };

            try {
                const response = await fetch(url, {
                    ...options,
                    headers
                });
                const data = await response.json().catch(() => ({}));
                return { response, data, status: response.status };
            } catch (error) {
                return { response: null, data: { error: error.message }, status: 0 };
            }
        }

        async function registerUser1() {
            const name = document.getElementById('user1Name').value;
            const email = document.getElementById('user1Email').value;
            const password = document.getElementById('user1Password').value;

            log(`Registering User1: ${name} (${email})`, 'info');
            const { response, data } = await apiCall('/auth/register', {
                method: 'POST',
                body: JSON.stringify({ name, email, password, role: 'user' })
            });

            if (response.ok) {
                user1.token = data.token;
                user1.id = data.user?.id || data.user?._id;
                user1.email = email;
                document.getElementById('user1Status').innerHTML = 
                    `<div class="status success">‚úÖ Registered! ID: ${user1.id}</div>`;
                log(`User1 registered successfully. ID: ${user1.id}`, 'success');
            } else {
                document.getElementById('user1Status').innerHTML = 
                    `<div class="status error">‚ùå ${data.error || data.message}</div>`;
                log(`User1 registration failed: ${data.error || data.message}`, 'error');
            }
        }

        async function loginUser1() {
            const email = document.getElementById('user1Email').value;
            const password = document.getElementById('user1Password').value;

            log(`Logging in User1: ${email}`, 'info');
            const { response, data } = await apiCall('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });

            if (response.ok) {
                user1.token = data.token;
                user1.id = data.user?.id || data.user?._id;
                user1.email = email;
                document.getElementById('user1Status').innerHTML = 
                    `<div class="status success">‚úÖ Logged in! ID: ${user1.id}</div>`;
                log(`User1 logged in successfully. ID: ${user1.id}`, 'success');
            } else {
                document.getElementById('user1Status').innerHTML = 
                    `<div class="status error">‚ùå ${data.error || data.message}</div>`;
                log(`User1 login failed: ${data.error || data.message}`, 'error');
            }
        }

        async function registerUser2() {
            const name = document.getElementById('user2Name').value;
            const email = document.getElementById('user2Email').value;
            const password = document.getElementById('user2Password').value;

            log(`Registering User2: ${name} (${email})`, 'info');
            const { response, data } = await apiCall('/auth/register', {
                method: 'POST',
                body: JSON.stringify({ name, email, password, role: 'user' })
            });

            if (response.ok) {
                user2.token = data.token;
                user2.id = data.user?.id || data.user?._id;
                user2.email = email;
                document.getElementById('user2Status').innerHTML = 
                    `<div class="status success">‚úÖ Registered! ID: ${user2.id}</div>`;
                log(`User2 registered successfully. ID: ${user2.id}`, 'success');
            } else {
                document.getElementById('user2Status').innerHTML = 
                    `<div class="status error">‚ùå ${data.error || data.message}</div>`;
                log(`User2 registration failed: ${data.error || data.message}`, 'error');
            }
        }

        async function loginUser2() {
            const email = document.getElementById('user2Email').value;
            const password = document.getElementById('user2Password').value;

            log(`Logging in User2: ${email}`, 'info');
            const { response, data } = await apiCall('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });

            if (response.ok) {
                user2.token = data.token;
                user2.id = data.user?.id || data.user?._id;
                user2.email = email;
                document.getElementById('user2Status').innerHTML = 
                    `<div class="status success">‚úÖ Logged in! ID: ${user2.id}</div>`;
                log(`User2 logged in successfully. ID: ${user2.id}`, 'success');
            } else {
                document.getElementById('user2Status').innerHTML = 
                    `<div class="status error">‚ùå ${data.error || data.message}</div>`;
                log(`User2 login failed: ${data.error || data.message}`, 'error');
            }
        }

        async function sendConnectionRequest() {
            if (!user1.token || !user2.id) {
                log('User1 must be logged in and User2 must be registered', 'error');
                return;
            }

            log('User1 sending connection request to User2...', 'info');
            const { response, data } = await apiCall('/connections/send', {
                method: 'POST',
                token: user1.token,
                body: JSON.stringify({ toUserId: user2.id })
            });

            if (response.ok) {
                connectionRequestId = data.connection?.id || data.connection?._id;
                document.getElementById('connectionStatus').innerHTML = 
                    `<div class="status success">‚úÖ Request sent! ID: ${connectionRequestId}</div>`;
                log(`Connection request sent successfully. ID: ${connectionRequestId}`, 'success');
            } else {
                document.getElementById('connectionStatus').innerHTML = 
                    `<div class="status error">‚ùå ${data.error || data.message}</div>`;
                log(`Failed to send request: ${data.error || data.message}`, 'error');
            }
        }

        async function getReceivedRequests() {
            if (!user2.token) {
                log('User2 must be logged in', 'error');
                return;
            }

            log('Fetching received requests for User2...', 'info');
            const { response, data } = await apiCall('/connections/received', {
                method: 'GET',
                token: user2.token
            });

            if (response.ok) {
                const requests = Array.isArray(data) ? data : [];
                if (requests.length > 0) {
                    connectionRequestId = requests[0]._id;
                    document.getElementById('connectionStatus').innerHTML = 
                        `<div class="status success">‚úÖ Found ${requests.length} request(s). First ID: ${connectionRequestId}</div>`;
                    log(`Found ${requests.length} request(s)`, 'success');
                } else {
                    document.getElementById('connectionStatus').innerHTML = 
                        `<div class="status info">‚ÑπÔ∏è No requests found</div>`;
                    log('No requests found', 'info');
                }
            } else {
                document.getElementById('connectionStatus').innerHTML = 
                    `<div class="status error">‚ùå ${data.error || data.message}</div>`;
                log(`Failed to fetch requests: ${data.error || data.message}`, 'error');
            }
        }

        async function acceptConnectionRequest() {
            if (!user2.token || !connectionRequestId) {
                log('User2 must be logged in and request ID must be available', 'error');
                return;
            }

            log(`User2 accepting connection request ${connectionRequestId}...`, 'info');
            const { response, data } = await apiCall(`/connections/${connectionRequestId}/accept`, {
                method: 'PUT',
                token: user2.token
            });

            if (response.ok) {
                document.getElementById('connectionStatus').innerHTML = 
                    `<div class="status success">‚úÖ Request accepted!</div>`;
                log('Connection request accepted successfully', 'success');
            } else {
                document.getElementById('connectionStatus').innerHTML = 
                    `<div class="status error">‚ùå ${data.error || data.message}</div>`;
                log(`Failed to accept request: ${data.error || data.message}`, 'error');
            }
        }

        async function getConnectedUsers() {
            if (!user1.token || !user2.token) {
                log('Both users must be logged in', 'error');
                return;
            }

            log('Fetching connected users...', 'info');
            const { response: res1, data: data1 } = await apiCall('/connections/connections', {
                method: 'GET',
                token: user1.token
            });
            const { response: res2, data: data2 } = await apiCall('/connections/connections', {
                method: 'GET',
                token: user2.token
            });

            if (res1.ok && res2.ok) {
                const user1HasUser2 = data1.some(c => c.id === user2.id || c.id?.toString() === user2.id?.toString());
                const user2HasUser1 = data2.some(c => c.id === user1.id || c.id?.toString() === user1.id?.toString());
                
                if (user1HasUser2 && user2HasUser1) {
                    document.getElementById('connectionStatus').innerHTML = 
                        `<div class="status success">‚úÖ Both users can see each other! User1: ${data1.length}, User2: ${data2.length}</div>`;
                    log('‚úÖ Connection verified - both users can see each other', 'success');
                } else {
                    document.getElementById('connectionStatus').innerHTML = 
                        `<div class="status error">‚ùå Connection verification failed</div>`;
                    log(`Connection verification failed. User1 has User2: ${user1HasUser2}, User2 has User1: ${user2HasUser1}`, 'error');
                }
            } else {
                document.getElementById('connectionStatus').innerHTML = 
                    `<div class="status error">‚ùå Failed to fetch connections</div>`;
                log('Failed to fetch connections', 'error');
            }
        }

        async function createChat() {
            if (!user1.token || !user2.id) {
                log('User1 must be logged in and User2 must be registered', 'error');
                return;
            }

            log('Creating/getting chat between User1 and User2...', 'info');
            const { response, data } = await apiCall(`/chat/chat/${user2.id}`, {
                method: 'GET',
                token: user1.token
            });

            if (response.ok) {
                chatId = data.chat?.id || data.chat?._id;
                document.getElementById('chatStatus').innerHTML = 
                    `<div class="status success">‚úÖ Chat created! ID: ${chatId}</div>`;
                log(`Chat created successfully. ID: ${chatId}`, 'success');
            } else {
                document.getElementById('chatStatus').innerHTML = 
                    `<div class="status error">‚ùå ${data.error || data.message}</div>`;
                log(`Failed to create chat: ${data.error || data.message}`, 'error');
            }
        }

        async function sendMessageUser1() {
            if (!user1.token || !chatId) {
                log('User1 must be logged in and chat must be created', 'error');
                return;
            }

            const message = prompt('Enter message from User1:') || 'Hello from User1!';
            log(`User1 sending message: "${message}"...`, 'info');
            const { response, data } = await apiCall(`/chat/messages/${chatId}`, {
                method: 'POST',
                token: user1.token,
                body: JSON.stringify({ content: message })
            });

            if (response.ok) {
                document.getElementById('chatStatus').innerHTML = 
                    `<div class="status success">‚úÖ Message sent!</div>`;
                log('Message sent successfully', 'success');
            } else {
                document.getElementById('chatStatus').innerHTML = 
                    `<div class="status error">‚ùå ${data.error || data.message}</div>`;
                log(`Failed to send message: ${data.error || data.message}`, 'error');
            }
        }

        async function sendMessageUser2() {
            if (!user2.token || !chatId) {
                log('User2 must be logged in and chat must be created', 'error');
                return;
            }

            const message = prompt('Enter message from User2:') || 'Hello from User2!';
            log(`User2 sending message: "${message}"...`, 'info');
            const { response, data } = await apiCall(`/chat/messages/${chatId}`, {
                method: 'POST',
                token: user2.token,
                body: JSON.stringify({ content: message })
            });

            if (response.ok) {
                document.getElementById('chatStatus').innerHTML = 
                    `<div class="status success">‚úÖ Message sent!</div>`;
                log('Message sent successfully', 'success');
            } else {
                document.getElementById('chatStatus').innerHTML = 
                    `<div class="status error">‚ùå ${data.error || data.message}</div>`;
                log(`Failed to send message: ${data.error || data.message}`, 'error');
            }
        }

        async function getMessages() {
            if (!user1.token || !chatId) {
                log('User1 must be logged in and chat must be created', 'error');
                return;
            }

            log('Fetching messages...', 'info');
            const { response, data } = await apiCall(`/chat/messages/${chatId}`, {
                method: 'GET',
                token: user1.token
            });

            if (response.ok) {
                const messages = data.messages || [];
                document.getElementById('chatStatus').innerHTML = 
                    `<div class="status success">‚úÖ Found ${messages.length} message(s)</div>`;
                log(`Found ${messages.length} message(s):`, 'success');
                messages.forEach((msg, idx) => {
                    log(`  ${idx + 1}. [${msg.sender?.name}]: ${msg.content}`, 'info');
                });
            } else {
                document.getElementById('chatStatus').innerHTML = 
                    `<div class="status error">‚ùå ${data.error || data.message}</div>`;
                log(`Failed to fetch messages: ${data.error || data.message}`, 'error');
            }
        }
    </script>
</body>
</html>

